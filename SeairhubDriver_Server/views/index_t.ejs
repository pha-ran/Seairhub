<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>WooJae</title>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script
	src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=l7xxeb4d570353e54f0da45c521b4607c944"></script>
<script type="text/javascript">
	var map;
	var markerLayer;
	var markerLayer2;
	//경로를 그려줄 레이어
	var routeLayer;
	var prtcl;
	//교통정보를 그려줄 레이어
	var vectorLayer;
	//출발지,도착지 마커
	var marker_s, marekr_e;
	//경로그림정보
	var drawInfoArr = [];
	var resultInfoArr1 = [];
	var resultInfoArr2 = [];
	var defaultRouteResult;

	var lat = "<%= lat%>";
	var lon = "<%= lon%>";

	// 임시 기본 위치를 학교로 설정
	if (lat == 0 && lon == 0) {
		lat = 37.5994
		lon = 126.8651
	}

	// HTML5의 geolocation으로 사용할 수 있는지 확인합니다 
	if (navigator.geolocation) {
		// GeoLocation을 이용해서 접속 위치를 얻어옵니다
		navigator.geolocation.getCurrentPosition(function(position) {
			lat = position.coords.latitude; // 위도
			lon = position.coords.longitude; // 경도
		});
	}

	function initTmap() {
		// 1. 지도 띄우기
		map = new Tmapv2.Map("map_div", {
			center : new Tmapv2.LatLng(37.520287, 126.932661),
			width : "100%",
			height : "400px",
			zoom : 14,
			zoomControl : true,
			scrollwheel : true

		});

		// 2. 시작, 도착 심볼찍기
		// 도착
		marker_e = new Tmapv2.Marker(
				{
					position : new Tmapv2.LatLng(37.520287, 126.932661),
					icon : "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_e.png",
					iconSize : new Tmapv2.Size(24, 38),
					map : map
				});

		// 3. 경로탐색 API 사용요청
		$("#btn_select")
				.click(
						
						function() {
							// 2. 시작, 도착 심볼찍기
							// 시작
							marker_s = new Tmapv2.Marker({
								position : new Tmapv2.LatLng(lat, lon),
								icon : "http://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png",
								iconSize : new Tmapv2.Size(24, 38),
								map : map
							});

							var searchOption = $("#selectLevel").val();
							
							$
									.ajax({
										method : "POST",
										url : "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result",//
										async : false,
										data : {
											"appKey" : "l7xxeb4d570353e54f0da45c521b4607c944",
											"startX" : lon,
											"startY" : lat,
											"endX" : "126.932661",
											"endY" : "37.520287",
											"reqCoordType" : "WGS84GEO",
											"resCoordType" : "EPSG3857",
											"searchOption" : "0",
											"trafficInfo" : "N"

										},

										success : function(response) {
											// 결과 출력
											var resultData = response.features;

											var tDistance = "총 거리 : "
													+ (resultData[0].properties.totalDistance / 1000)
															.toFixed(1) + "km,";
											var tTime = " 총 시간 : "
													+ (resultData[0].properties.totalTime / 60)
															.toFixed(0) + "분,";
											var tFare = " 총 요금 : "
													+ resultData[0].properties.totalFare
													+ "원,";
											var taxiFare = " 예상 택시 요금 : "
													+ resultData[0].properties.taxiFare
													+ "원";

											defaultRouteResult = "한강교랑(5개소) 천호대교,영동대교,원효대교,잠수교,성산대교 는  총 중량 32톤을 초과하는 화물차가 이용할 수 없습니다.</br>"
													+ "<br><br>자동차 경로안내 결과 : "
													+ tDistance
													+ tTime
													+ tFare
													+ taxiFare
													+ "<br><br>화물차 경로안내 결과 : ";

											$("#result").html(
													defaultRouteResult);

											//지도 라인 초기화
											if (resultInfoArr1.length > 0) {
												for (var i = 0; i < resultInfoArr1.length; i++) {
													resultInfoArr1[i]
															.setMap(null);
												}
												resultInfoArr1 = [];
											}

											for ( var i in resultData) { //for문 [S]
												var geometry = resultData[i].geometry;
												var properties = resultData[i].properties;
												var polyline_;

												drawInfoArr = [];

												if (geometry.type == "LineString") {
													for ( var j in geometry.coordinates) {
														// 경로들의 결과값(구간)들을 포인트 객체로 변환 
														var latlng = new Tmapv2.Point(
																geometry.coordinates[j][0],
																geometry.coordinates[j][1]);
														// 포인트 객체를 받아 좌표값으로 변환
														var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
																latlng);
														// 포인트객체의 정보로 좌표값 변환 객체로 저장
														var convertChange = new Tmapv2.LatLng(
																convertPoint._lat,
																convertPoint._lng);
														// 배열에 담기
														drawInfoArr
																.push(convertChange);
													}

													polyline_ = new Tmapv2.Polyline(
															{
																path : drawInfoArr,
																strokeColor : "#0000FF", //BLUE
																strokeWeight : 6,
																map : map
															});
													resultInfoArr1
															.push(polyline_);

												}
											}//for문 [E]

										},
										error : function(request, status, error) {
											console.log("code:"
													+ request.status + "\n"
													+ "message:"
													+ request.responseText
													+ "\n" + "error:" + error);
										}
									});

							setTimeout(
									function() {
										$
												.ajax({
													method : "POST",
													url : "https://apis.openapi.sk.com/tmap/truck/routes?version=1&format=json&callback=result",//
													async : false,
													data : {
														"appKey" : "l7xxeb4d570353e54f0da45c521b4607c944",
														"startX" : lon,
														"startY" : lat,
														"endX" : "126.932661",
														"endY" : "37.520287",
														"reqCoordType" : "WGS84GEO",
														"resCoordType" : "EPSG3857",
														"angle" : "172",
														"searchOption" : searchOption,
														"trafficInfo" : "Y",
														"truckType" : "1",
														"truckWidth" : "100",
														"truckHeight" : "100",
														"truckWeight" : "35000",
														"truckTotalWeight" : "35000",
														"truckLength" : "200"
													},
													success : function(response) {
														// 결과 출력
														var resultData = response.features;

														var tDistance = "총 거리 : "
																+ (resultData[0].properties.totalDistance / 1000)
																		.toFixed(1)
																+ "km,";
														var tTime = " 총 시간 : "
																+ (resultData[0].properties.totalTime / 60)
																		.toFixed(0)
																+ "분,";
														var tFare = " 총 요금 : "
																+ resultData[0].properties.totalFare
																+ "원,";
														var taxiFare = " 예상 택시 요금 : "
																+ resultData[0].properties.taxiFare
																+ "원";

														$("#result")
																.html(
																		defaultRouteResult
																				+ tDistance
																				+ tTime
																				+ tFare
																				+ taxiFare);

														if (resultInfoArr2.length > 0) {
															for (var k = 0; k < resultInfoArr2.length; k++) {
																resultInfoArr2[k]
																		.setMap(null);
															}
														}
														resultInfoArr2 = [];

														for ( var i in resultData) { //for문 [S]
															var geometry = resultData[i].geometry;
															var properties = resultData[i].properties;
															var polyline_;

															drawInfoArr = [];

															if (geometry.type == "LineString") {
																for ( var j in geometry.coordinates) {
																	// 경로들의 결과값(구간)들을 포인트 객체로 변환 
																	var latlng = new Tmapv2.Point(
																			geometry.coordinates[j][0],
																			geometry.coordinates[j][1]);
																	// 포인트 객체를 받아 좌표값으로 변환
																	var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
																			latlng);
																	// 포인트객체의 정보로 좌표값 변환 객체로 저장
																	var convertChange = new Tmapv2.LatLng(
																			convertPoint._lat,
																			convertPoint._lng);
																	// 배열에 담기
																	drawInfoArr
																			.push(convertChange);
																}

																polyline_ = new Tmapv2.Polyline(
																		{
																			path : drawInfoArr,
																			strokeColor : "#FF0000", //RED
																			strokeWeight : 6,
																			map : map
																		});
																resultInfoArr2
																		.push(polyline_);
															}
														}//for문 [E]
													},
													error : function(request,
															status, error) {
														console
																.log("code:"
																		+ request.status
																		+ "\n"
																		+ "message:"
																		+ request.responseText
																		+ "\n"
																		+ "error:"
																		+ error);
													}
												});
									}, 1000);
						});
		//맵 중심영역 재설정
		var mapBoundInfo = map.getBounds();
		map.fitBounds(mapBoundInfo, 50);
	}

	function addComma(num) {
		var regexp = /\B(?=(\d{3})+(?!\d))/g;
		return num.toString().replace(regexp, ',');
	}
</script>
</head>
<body onload="initTmap();">
	<div class="ft_area" style="width: 940px;">
		<div class="ft_select_wrap">
			<div class="ft_select">
				<select id="selectLevel">
					<option value="0" selected="selected">교통최적+추천</option>
					<option value="1">교통최적+무료우선</option>
					<option value="2">교통최적+최소시간</option>
					<option value="3">교통최적+초보</option>
					<option value="4">교통최적+고속도로우선</option>
					<option value="10">최단거리+유/무료</option>
					<option value="12">이륜차도로우선</option>
				</select>
				<button id="btn_select">적용하기</button>
			</div>

		</div>

		<div class="map_act_btn_wrap clear_box">
			<!-- <button onClick="trafficInfo()" style="margin-left:15px;margin-top:8px;">교통정보 표출</button> -->
			<!-- <p style="margin-left:15px;margin-top:8px; margin:left;">교통정보 표출</p> -->
		</div>
		<div class="clear"></div>
	</div>

	<div id="map_wrap" class="map_wrap">
		<div id="map_div"></div>
	</div>
	<div class="map_act_btn_wrap clear_box"></div>
	<p id="result"></p>
</body>
</html>